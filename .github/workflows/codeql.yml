name: CodeQL Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Check for SQL Injection
        run: |
          echo "üîç Checking for SQL injection vulnerabilities..."
          
          # Check for unsafe string concatenation in SQL queries
          if grep -r "SELECT.*FROM.*WHERE.*=.*\${" . --include="*.js" --exclude-dir=node_modules; then
            echo "‚ùå SQL Injection vulnerability found: String interpolation in SQL query"
            exit 1
          fi
          
          if grep -r "SELECT.*FROM.*WHERE.*=.*+" . --include="*.js" --exclude-dir=node_modules | grep -v "?"; then
            echo "‚ùå SQL Injection vulnerability found: String concatenation in SQL query"
            exit 1
          fi
          
          echo "‚úÖ No SQL injection patterns detected"
      
      - name: Check for Hardcoded Credentials
        run: |
          echo "üîç Checking for hardcoded credentials..."
          
          # Check for hardcoded passwords/secrets (excluding SQL queries, .env files, and env variables)
          if grep -rE "(password|secret|api_key|apikey|token)\s*=\s*['\"][^?$]" . --include="*.js" --exclude-dir=node_modules | grep -v "process.env" | grep -v ".env" | grep -v "SET password = ?" | grep -v "UPDATE.*password.*\?"; then
            echo "‚ùå Hardcoded credentials found"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded credentials detected"
      
      - name: Verify Environment Variables Usage
        run: |
          echo "üîç Verifying environment variables are used..."
          
          # Check that DB credentials use environment variables
          if ! grep -rq "process.env.DB_HOST" . --include="*.js" --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è DB_HOST environment variable not found (might be using different config)"
          fi
          
          if ! grep -rq "process.env.DB_USER" . --include="*.js" --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è DB_USER environment variable not found (might be using different config)"
          fi
          
          if ! grep -rq "process.env.DB_PASSWORD" . --include="*.js" --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è DB_PASSWORD environment variable not found (might be using different config)"
          fi
          
          echo "‚úÖ Environment variables check completed"
      
      - name: Check for Parameterized Queries
        run: |
          echo "üîç Checking for parameterized queries..."
          
          # Verify parameterized queries are used in routes
          if grep -rq 'db.query.*\[.*\]' routes/ --include="*.js" 2>/dev/null; then
            echo "‚úÖ Parameterized queries detected in routes"
          else
            echo "‚ö†Ô∏è Parameterized queries not clearly detected - manual review recommended"
          fi
          
          # Check for any direct query concatenation
          if grep -r 'db.query.*".*+' routes/ --include="*.js" 2>/dev/null; then
            echo "‚ùå Direct query string concatenation detected"
            exit 1
          fi
          
          echo "‚úÖ Parameterized queries check completed"
      
      - name: Check for XSS Vulnerabilities
        run: |
          echo "üîç Checking for XSS vulnerabilities..."
          
          # Check for innerHTML usage
          if grep -r "innerHTML" . --include="*.js" --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è innerHTML usage detected - ensure proper sanitization"
          fi
          
          # Check for eval usage
          if grep -r "eval(" . --include="*.js" --exclude-dir=node_modules; then
            echo "‚ùå eval() usage detected - security risk"
            exit 1
          fi
          
          echo "‚úÖ XSS check completed"
      
      - name: Check for Insecure Dependencies
        run: |
          echo "üîç Running npm audit..."
          npm audit --audit-level=high || echo "‚ö†Ô∏è Vulnerabilities found in dependencies"
      
      - name: Security Summary
        if: always()
        run: |
          echo "================================"
          echo "üõ°Ô∏è  Security Analysis Complete"
          echo "================================"
          echo "Check the logs above for any security issues"